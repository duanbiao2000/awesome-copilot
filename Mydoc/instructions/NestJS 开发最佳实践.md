# NestJS 开发最佳实践

## 核心技术简介

NestJS 是一个用于构建高效、可扩展的 Node.js 服务器端应用程序的渐进式框架。它使用 TypeScript 构建，结合了面向对象编程(OOP)、函数式编程(FP)和函数响应式编程(FRP)的元素，提供了强大的依赖注入系统、模块化架构和丰富的装饰器功能。

## 核心原则

### 依赖注入(DI)

- 使用 `@Injectable()` 装饰器标记服务、仓库等提供者
- 通过构造函数参数进行依赖注入，确保类型安全
- 优先使用基于接口的依赖注入提高可测试性
- 在需要特定实例化逻辑时使用自定义提供者

### 模块化架构

- 使用 `@Module()` 装饰器创建功能模块
- 仅导入必要的模块，避免循环依赖
- 使用 `forRoot()` 和 `forFeature()` 模式创建可配置模块
- 为通用功能实现共享模块

### 装饰器和元数据

- 使用适当装饰器：`@Controller()`、`@Get()`、`@Post()`、`@Injectable()`
- 应用 `class-validator` 库的验证装饰器
- 为横切关注点使用自定义装饰器
- 在高级场景中实现元数据反射

## 项目结构规范

### 推荐目录结构

```
src/
├── app.module.ts
├── main.ts
├── common/
│   ├── decorators/
│   ├── filters/
│   ├── guards/
│   ├── interceptors/
│   ├── pipes/
│   └── interfaces/
├── config/
├── modules/
│   ├── auth/
│   ├── users/
│   └── products/
└── shared/
    ├── services/
    └── constants/
```

### 文件命名约定

- **控制器**：`*.controller.ts` (如 `users.controller.ts`)
- **服务**：`*.service.ts` (如 `users.service.ts`)
- **模块**：`*.module.ts` (如 `users.module.ts`)
- **DTO**：`*.dto.ts` (如 `create-user.dto.ts`)
- **实体**：`*.entity.ts` (如 `user.entity.ts`)

## API 开发模式

### 控制器实现

- 保持控制器精简，将业务逻辑委托给服务
- 使用适当的 HTTP 方法和状态码
- 使用 DTO 实现全面的输入验证
- 在适当层级应用守卫和拦截器

### 服务层实现

- 在服务中实现业务逻辑，而非控制器
- 使用构造函数依赖注入
- 创建专注的单一职责服务
- 适当处理错误，让过滤器捕获

### DTO 和验证

- 使用 class-validator 装饰器进行输入验证
- 为不同操作创建独立 DTO（创建、更新、查询）
- 使用 class-transformer 实现适当转换

## 数据库集成

### TypeORM 集成

- 使用 TypeORM 作为主要 ORM 进行数据库操作
- 使用适当装饰器定义实体和关系
- 实现仓库模式进行数据访问
- 使用迁移管理数据库模式变更

### 自定义仓库

- 在需要时扩展基础仓库功能
- 在仓库方法中实现复杂查询
- 使用查询构建器处理动态查询

## 认证授权

### JWT 认证

- 使用 Passport 实现基于 JWT 的认证
- 使用守卫保护路由
- 创建自定义装饰器处理用户上下文

### 基于角色的访问控制

- 使用自定义守卫和装饰器实现 RBAC
- 使用元数据定义所需角色
- 创建灵活的权限系统

## 错误处理和日志

### 异常过滤器

- 创建全局异常过滤器实现一致的错误响应
- 适当处理不同类型的异常
- 使用适当上下文记录错误

### 日志记录

- 使用内置 Logger 类实现一致日志记录
- 实现适当的日志级别（error、warn、log、debug、verbose）
- 在日志中添加上下文信息

## 测试策略

### 单元测试

- 使用模拟独立测试服务
- 使用 Jest 作为测试框架
- 为业务逻辑创建全面测试套件

### 集成测试

- 使用 TestingModule 进行集成测试
- 测试完整的请求/响应周期
- 适当模拟外部依赖

### 端到端测试

- 测试完整应用流程
- 使用 supertest 进行 HTTP 测试
- 测试认证和授权流程

## 性能和安全

### 性能优化

- 使用 Redis 实现缓存策略
- 使用拦截器进行响应转换
- 使用适当索引优化数据库查询
- 为大数据集实现分页

### 安全最佳实践

- 使用 class-validator 验证所有输入
- 实现速率限制防止滥用
- 适当使用 CORS 处理跨域请求
- 清理输出防止 XSS 攻击
- 使用环境变量管理敏感配置

## 配置管理

### 环境配置

- 使用 @nestjs/config 管理配置
- 在启动时验证配置
- 为不同环境使用不同配置

## 常见陷阱避免

- 避免循环依赖
- 不要在控制器中放置业务逻辑
- 始终适当处理错误
- 不要手动创建实例而应使用 DI
- 始终验证输入数据
- 对数据库和外部 API 调用使用 async/await
- 正确处理订阅和事件监听器避免内存泄漏

## 开发工作流

### 开发设置

1. 使用 NestJS CLI 脚手架：`nest generate module users`
2. 遵循一致的文件组织
3. 使用 TypeScript 严格模式
4. 使用 ESLint 实现全面代码检查
5. 使用 Prettier 进行代码格式化

通过遵循这些最佳实践，可以创建可维护、可测试且高效的服务器端应用程序，充分发挥 TypeScript 和现代开发模式的强大功能。
